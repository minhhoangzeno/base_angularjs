/*
 * Copyright (c) Akveo 2019. All Rights Reserved.
 * Licensed under the Single Application / Multi Application License.
 * See LICENSE_SINGLE_APP / LICENSE_MULTI_APP in the 'docs' folder for license information on type of purchased license.
 */

import { NbIconLibraries, NbMenuItem } from '@nebular/theme';
import { Observable } from 'rxjs';
import { Injectable } from '@angular/core';
import { UserStore } from '../@core/stores/user.store';
import { first, map } from 'rxjs/operators';

@Injectable()
export class PagesMenu {
  constructor(
    private readonly iconLibraries: NbIconLibraries,
    private readonly userStore: UserStore,
  ) {
    this.iconLibraries.registerSvgPack('simcel-icon', {
      biz: `<svg width="30" height="30" viewBox="0 0 300 300"><path d="M129.57,146a35.68,35.68,0,0,1,16.86,11.74,29.78,29.78,0,0,1,6.08,18.68q0,17-11.82,27.47t-31.12,10.43H51.16V85.68h57.72q16.52,0,26.51,9.39t10,25Q145.38,136.62,129.57,146Zm-53.2-39.46v32.33h24.16q8.52,0,13.65-4.43a16.08,16.08,0,0,0,.09-23.47q-5.05-4.43-13.56-4.43Zm29.38,86.92q9.21,0,14.86-5a17.77,17.77,0,0,0,.09-25.91q-5.57-4.95-14.78-4.95H76.37v35.81Z" fill="#778692"/><path d="M182.53,147.71a8.46,8.46,0,0,1-6.18,2.42,8.54,8.54,0,1,1,0-17.07,8.49,8.49,0,0,1,6.18,2.41,8.84,8.84,0,0,1,0,12.24Zm-13.38,11.06h14.4v55.55h-14.4Z" fill="#778692"/><path d="M221.57,204h27.27v10.29H200.69q0-3.09,4.48-10.75t12-18.93q7.56-11.26,10.24-15.58H201.11V158.77h47.21q0,3-4.53,10.7t-12,18.93Q224.25,199.61,221.57,204Z" fill="#778692"/></svg>`,
      demand: `<svg width="30" height="30" viewBox="0 0 300 300"><path d="M142.86,76.64q32.52,0,52.44,20.22T215.23,150q0,32.91-19.93,53.14t-52.44,20.22H84.77V76.64Zm0,122.93q19.23,0,30.93-13.68T185.49,150q0-22.2-11.7-35.89t-30.93-13.68H113.52v99.14Z" fill="#778692"/></svg>`,
      scenario: `<svg width="30" height="30" viewBox="0 0 300 300"><path d="M107.4,186.65a13.4,13.4,0,0,0-6.73-12q-6.72-4.24-20.18-7.56l-6.64-1.66a141,141,0,0,1-16.68-5.07,55.6,55.6,0,0,1-12.35-6.82,24.74,24.74,0,0,1-8.67-10.87,42.26,42.26,0,0,1-2.67-16q0-20.08,13.27-31T84,84.9a109.25,109.25,0,0,1,42.77,8.29v20.09q-20.46-6.81-36.69-6.82-29.49,0-29.49,15.67a13.43,13.43,0,0,0,.73,4.61,8.8,8.8,0,0,0,3,3.78q2.22,1.75,3.6,2.67a26.11,26.11,0,0,0,5.53,2.31q4.14,1.38,5.81,1.75c1.1.25,3.44.86,7,1.84l6.45,1.48q19.92,5,30.79,14.56t10.87,28q0,19.72-13.18,30.79T84.54,225a122.45,122.45,0,0,1-24.33-2.58,79,79,0,0,1-21.39-7.19V195a93.75,93.75,0,0,0,38.53,8.48Q107.4,203.43,107.4,186.65Z" fill="#778692"/><path d="M195.57,177.88a36.07,36.07,0,0,0-14-2.72q-9.06,0-14.62,5.12a17.39,17.39,0,0,0-5.56,13.42q0,8.4,5.61,13.47t14.89,5.07a45.92,45.92,0,0,0,14.73-2.72v11.23q-8.07,3.5-19.63,3.49-14.09,0-22.75-8.4t-8.67-22.14q0-13.74,8.67-22.14t22.75-8.4a48.89,48.89,0,0,1,18.54,3.49Z" fill="#778692"/><path d="M226.38,210.06h40.14v13.09h-56V142.43h55.09v13.09H226.38V175.7h35.78v13H226.38Z" fill="#778692"/></svg>`,
      supply: `<svg width="30" height="30" viewBox="0 0 300 300"><path d="M176.31,185.5a15,15,0,0,0-7.53-13.42q-7.53-4.74-22.6-8.46l-7.43-1.86a157.17,157.17,0,0,1-18.68-5.67,62.33,62.33,0,0,1-13.82-7.64,27.69,27.69,0,0,1-9.7-12.17q-3-7.34-3-17.86,0-22.48,14.86-34.67T150.1,71.57A122.34,122.34,0,0,1,198,80.86v22.5q-22.92-7.64-41.08-7.64-33,0-33,17.54a15,15,0,0,0,.83,5.16,9.71,9.71,0,0,0,3.3,4.23q2.47,2,4,3a30.11,30.11,0,0,0,6.19,2.58q4.63,1.54,6.5,2t7.84,2.06l7.22,1.65q22.29,5.58,34.47,16.31t12.18,31.37q0,22.08-14.76,34.46t-41,12.39a137.53,137.53,0,0,1-27.24-2.89q-14.24-2.89-23.94-8v-22.7a104.83,104.83,0,0,0,43.13,9.49Q176.32,204.28,176.31,185.5Z" fill="#778692"/></svg>`,
      setting: `<svg width="30" height="30" viewBox="0 0 300 300"><g id="vUdcIY"><path d="M163,258.34H136.8c-2.68-6.66-5.38-13.32-8-20-.49-1.26-1.51-1.55-2.61-1.85a84.75,84.75,0,0,1-20.78-8.74,3.32,3.32,0,0,0-3.35-.19c-5.94,2.6-11.92,5.09-17.85,7.71a2.73,2.73,0,0,1-3.53-.67q-7.47-7.62-15.1-15.09a3,3,0,0,1-.75-3.88c2.62-5.85,5.11-11.76,7.66-17.64a3.14,3.14,0,0,0,0-3.18,86,86,0,0,1-9-21.59,2.89,2.89,0,0,0-1.82-2.14l-20.06-7.87V137c6.6-2.66,13.18-5.35,19.79-8a3.24,3.24,0,0,0,1.91-2.57,83.3,83.3,0,0,1,8.54-20.63,4,4,0,0,0,.21-4c-2.51-5.81-4.88-11.69-7.4-17.51a2.74,2.74,0,0,1,.72-3.53c5-4.93,10-9.89,14.93-15a3.22,3.22,0,0,1,4.25-.76c5.78,2.6,11.64,5,17.43,7.6a3.55,3.55,0,0,0,3.56-.21A84,84,0,0,1,126,64a4.29,4.29,0,0,0,3.25-2.89c2.22-5.79,4.62-11.5,6.85-17.29a2.84,2.84,0,0,1,3.1-2.15q10.67.14,21.35,0a2.87,2.87,0,0,1,3.14,2.11c2.24,5.7,4.67,11.33,6.91,17a4.35,4.35,0,0,0,3.26,2.89,81.1,81.1,0,0,1,20.24,8.38,3.93,3.93,0,0,0,3.95.26c5.69-2.46,11.45-4.76,17.12-7.25a3.24,3.24,0,0,1,4.26.78q7.28,7.52,14.79,14.79a3.09,3.09,0,0,1,.69,4.08c-2.62,5.85-5.09,11.76-7.67,17.63a3.13,3.13,0,0,0,.12,3.17,84.2,84.2,0,0,1,8.74,21,3.9,3.9,0,0,0,2.71,2.88c5.84,2.27,11.63,4.67,17.48,6.93a2.74,2.74,0,0,1,2,3q-.1,10.77,0,21.55a2.77,2.77,0,0,1-2,3c-5.76,2.28-11.46,4.72-17.23,7a4.12,4.12,0,0,0-2.75,3.11,80.55,80.55,0,0,1-8.47,20.44,3.93,3.93,0,0,0-.17,4c2.49,5.75,4.83,11.56,7.32,17.32a2.86,2.86,0,0,1-.67,3.72q-7.63,7.46-15.09,15.1c-1.27,1.31-2.35,1.34-3.9.65-5.78-2.6-11.61-5.09-17.4-7.66a3.31,3.31,0,0,0-3.37-.05,85.68,85.68,0,0,1-21.58,9,2.89,2.89,0,0,0-2.13,1.83Q167,248.32,163,258.34ZM150,204c30.3-.52,53.78-24,53.77-53.91a53.84,53.84,0,1,0-107.68.14C96.17,180.54,120.09,203.62,150,204Z" fill="#778692"/><path d="M149.86,116.94a33.16,33.16,0,1,1-33.12,33.14A32.89,32.89,0,0,1,149.86,116.94Z" fill="#778692"/></g></svg>`,
    });
  }

  getMenu(): Observable<NbMenuItem[]> {

    const dashboardMenu: NbMenuItem[] = [
      {
        title: 'Business Explorer',
        icon: { icon: 'biz', pack: 'simcel-icon' },
        link: '/pages/explorer/business-explorer',
        home: true,
      },
      {
        title: 'Demand Planning',
        icon: { icon: 'demand', pack: 'simcel-icon' },
        link: '/pages/explorer/demand-planning',
      },
      {
        title: 'Supply Explorer',
        icon: { icon: 'supply', pack: 'simcel-icon' },
        link: '/pages/explorer/supply-explorer',
      },
      {
        title: 'Scenario Explorer',
        icon: { icon: 'scenario', pack: 'simcel-icon' },
        link: '/pages/explorer/scenario-explorer',
      },
      {
        title: 'Auth',
        icon: { icon: 'setting', pack: 'simcel-icon' },
      },
    ];

    return this.userStore.onUserStateChange().pipe(
      first((u) => !!u),
      map(() => {
        const flags = this.userStore.currentWorkspace()?.flags;
        // strict compare the flag value
        if (flags?.scenarioExplorer === false) {
          return dashboardMenu.filter((d) => d.link !== '/pages/explorer/scenario-explorer');
        }
        // get pathname url , if d.link = url then menu item selected
        dashboardMenu.map(d => {
          if (d.link == window.location.pathname) {
            d.selected = true
          }
        })

        // url in demand-planning , open Manage events and forecast => menu item demand planning selected
        if ((window.location.pathname == '/pages/explorer/events-management') || (window.location.pathname == '/pages/explorer/forecast')) {
          dashboardMenu[1].selected = true;
        }
        return [...dashboardMenu];
      }),
    );
  }
}
